<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoR 很有將練習</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .space-menu-item, .word-card, .category-btn { transition: all 0.2s ease-in-out; }
        .word-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .space-menu-item:hover { background-color: #f1f5f9; color: #1e293b; }
        .space-menu-item.active { background-color: #eef2ff; color: #4338ca; font-weight: 600; }
        .category-btn.active { background-color: #4f46e5; color: white; }
        #word-details-canvas { transition: all 0.3s ease-in-out; position: relative; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800">

    <div id="app-container" class="max-w-7xl mx-auto p-4 md:p-6">
        <header class="mb-6 md:mb-8">
            <div class="flex flex-wrap gap-4 justify-between items-center">
                <h1 class="text-2xl md:text-3xl font-bold text-slate-900">Contextual AI</h1>
                 <div id="controls-container" class="flex items-center gap-2 flex-wrap">
                    <!-- 控制項將由 JS 動態生成 -->
                 </div>
            </div>
        </header>
        <main>
            <div id="sentence-constructor" class="bg-white rounded-2xl shadow-lg mb-8 p-6 md:p-8 flex items-center justify-center text-center"></div>
            <div id="word-details-canvas" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8"></div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <aside class="md:col-span-1">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">情境選單</h3>
                    <div id="space-menu" class="space-y-2"></div>
                </aside>
                <div class="md:col-span-3">
                     <h3 id="word-list-title" class="text-lg font-semibold text-slate-800 mb-4">相關單字</h3>
                    <div id="word-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- 全域資料庫 ---
        let DB = { patterns: [], words: [], spaces: [] };
        
        // --- 應用程式狀態 ---
        let state = {};

        // --- DOM 節點 ---
        const spaceMenu = document.getElementById('space-menu');
        const wordGrid = document.getElementById('word-grid');
        const sentenceConstructor = document.getElementById('sentence-constructor');
        const wordDetailsCanvas = document.getElementById('word-details-canvas');
        const controlsContainer = document.getElementById('controls-container');
        
        // --- 核心函數 ---
        async function init() {
            sentenceConstructor.innerHTML = `<div class="loader"></div>`;
            await fetchDataFromGoogleSheet();
            
            const patterns = DB.patterns || [];
            if (patterns.length === 0) {
                displayError("很抱歉，無法從您的 Google Sheet 載入任何有效的句型資料。<br>請檢查您的「句型庫」工作表是否有內容且欄位名稱正確。");
                return;
            }
            
            const firstCategory = patterns[0]?.句型分類 || null;
            const patternsForFirstCategory = firstCategory ? patterns.filter(p => p.句型分類 === firstCategory) : [];
            const firstPattern = patternsForFirstCategory[0] || null;

            state = {
                currentCategory: firstCategory,
                currentPattern: firstPattern,
                activeSpace: (DB.spaces[0] || {}).情境名稱 || '未分類',
                selectedSubject: 'I',
                selectedWords: [], 
                isLoadingAi: false,
            };
            
            setupEventListeners();
            render();
        }

        async function fetchDataFromGoogleSheet() {
            const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbyMWFlxE98Wwjl37HuRZfMhcSU3oJEdYsJerZO89eTCaoMDGEP-p3rrE9XbOYcN3xqJ/exec'; // ⚠️ 請貼上您的 Apps Script 網址
            
            try {
                if (appsScriptUrl === 'YOUR_APPS_SCRIPT_URL') { // **FIXED**: Corrected the placeholder URL check
                     throw new Error("尚未設定 Google Apps Script 網址。");
                }
                const response = await fetch(appsScriptUrl);
                if (!response.ok) throw new Error('網路回應錯誤: ' + response.statusText);
                const data = await response.json();
                
                DB.patterns = data.句型庫 || [];
                DB.words = data.單字庫 || [];
                DB.spaces = data.情境庫 || [];

            } catch (error) {
                console.error("無法從 Google Sheet 讀取資料:", error);
                displayError(`很抱歉，無法從 Google Sheet 讀取資料。<br>請確認您的 Apps Script 網址是否正確，且共用設定為「知道連結的任何人」。<br><small class="mt-2 block">${error.message}</small>`);
            }
        }
        
        async function fetchAiDataForWord(wordData) {
            const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbyMWFlxE98Wwjl37HuRZfMhcSU3oJEdYsJerZO89eTCaoMDGEP-p3rrE9XbOYcN3xqJ/exec'; // ⚠️ 請再次確認這裡也填上了您的網址
            setState({ isLoadingAi: true });
            
            try {
                 const response = await fetch(appsScriptUrl, {
                    method: 'POST',
                    mode: 'cors', 
                    credentials: 'omit',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ word: wordData.單字, contexts: DB.spaces.map(s => s.情境名稱) })
                });
                if (!response.ok) throw new Error('AI API 回應錯誤');
                const aiData = await response.json();
                
                const fullWordData = {
                    ...wordData,
                    發音: aiData.pronunciation,
                    詞性: aiData.partOfSpeech,
                    情境: aiData.context,
                    AI老師點評: aiData.aiNotes,
                    道地例句: aiData.exampleSentences,
                };

                const placeholders = (state.currentPattern.結構樣板.match(/\[[A-Z0-9_]+\]/g) || []);
                let newSelectedWords = [...state.selectedWords];

                if (newSelectedWords.length < placeholders.length) {
                    newSelectedWords.push(fullWordData);
                } else {
                    newSelectedWords[newSelectedWords.length - 1] = fullWordData;
                }
                
                setState({ selectedWords: newSelectedWords, isLoadingAi: false });

            } catch(error) {
                console.error("呼叫 AI 失敗:", error);
                alert("抱歉，呼叫 AI 老師失敗，請稍後再試。");
                setState({ isLoadingAi: false });
            }
        }

        function setState(newState) { Object.assign(state, newState); render(); }

        function render() {
            if (!state.currentPattern) {
                displayError("應用程式狀態錯誤：找不到當前句型。");
                return;
            };
            renderControls();
            renderSentenceConstructor();
            renderWordDetailsCanvas();
            renderSpaceMenu();
            renderWordGrid();
        }
        
        function renderControls() {
            const { currentCategory, currentPattern } = state;
            const categories = [...new Set(DB.patterns.map(p => p.句型分類))];
            const patternsForCategory = DB.patterns.filter(p => p.句型分類 === currentCategory);

            let categoryButtonsHTML = `<div class="flex items-center gap-1 bg-slate-200 p-1 rounded-lg">
                ${categories.map(cat => `<button data-category="${cat}" class="category-btn px-3 py-1 text-sm font-semibold rounded-md ${cat === currentCategory ? 'active' : 'text-slate-600'}">${cat}</button>`).join('')}
            </div>`;

            let patternSelectorHTML = `<select id="pattern-selector" class="rounded-md border-slate-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                ${patternsForCategory.map(p => `<option value="${p.句型名稱}">${p.句型名稱}</option>`).join('')}
            </select>`;
            
            controlsContainer.innerHTML = categoryButtonsHTML + patternSelectorHTML;
            if (currentPattern) {
                document.getElementById('pattern-selector').value = currentPattern.句型名稱;
            }
        }

        function renderSentenceConstructor() {
             const { currentPattern, selectedSubject, selectedWords } = state;
             const subjects = ['I', 'You', 'He', 'She', 'It', 'We', 'They'];
             
             let subjectSelectorHTML = `<select id="subject-selector" class="bg-gray-200 rounded px-2 py-1 mx-2 font-bold focus:ring-2 focus:ring-indigo-400 outline-none">
                ${subjects.map(s => `<option value="${s}" ${s === selectedSubject ? 'selected' : ''}>${s}</option>`).join('')}
             </select>`;

             const verbMap = {
                'be': { 'I': 'am', 'He': 'is', 'She': 'is', 'It': 'is', 'default': 'are'},
                'have': { 'I': 'have', 'He': 'has', 'She': 'has', 'It': 'has', 'default': 'have' }
             };
             
             const getVerb = (verbType, subject) => {
                return verbMap[verbType]?.[subject] || verbMap[verbType]?.default || verbType;
             }

             let sentenceHTML = currentPattern.結構樣板;
             sentenceHTML = sentenceHTML.replace(/\[S\]/g, subjectSelectorHTML);
             sentenceHTML = sentenceHTML.replace(/\[V_be\]/g, `<span class="text-green-600 font-bold">${getVerb('be', selectedSubject)}</span>`);
             sentenceHTML = sentenceHTML.replace(/\[V_have\]/g, `<span class="text-green-600 font-bold">${getVerb('have', selectedSubject)}</span>`);
             
             const placeholders = (currentPattern.結構樣板.match(/\[(C\d*|O|V_inf)_(\w+)\]/g) || []);
             placeholders.forEach((ph, i) => {
                const word = selectedWords[i];
                sentenceHTML = sentenceHTML.replace(ph, `<span class="text-indigo-600 font-bold px-4 py-2 bg-indigo-50 rounded-md cursor-pointer" data-word-index="${i}">${word ? word.單字 : '...'}</span>`);
             });

             sentenceConstructor.innerHTML = `<p class="text-2xl lg:text-3xl text-slate-800">${sentenceHTML}</p>`;
        }
        
        function renderWordDetailsCanvas() {
            const { isLoadingAi, selectedWords } = state;
            if(isLoadingAi) {
                wordDetailsCanvas.innerHTML = `<div class="loader"></div>`;
                return;
            }
            if (selectedWords.length > 0) {
                 wordDetailsCanvas.innerHTML = selectedWords.map(word => `
                    <div class="word-details-card bg-white border-indigo-500 p-4 rounded-lg shadow">
                         <h3 class="font-bold text-lg">${word.單字} <span class="text-base font-normal text-slate-500">${word.詞性}</span></h3>
                         <div class="mt-2"><strong class="font-semibold">發音:</strong> <span class="text-slate-700">${word.發音 || 'N/A'}</span></div>
                         <div class="mt-2"><strong class="font-semibold">AI 點評:</strong> <span class="text-slate-700">${word.AI老師點評 || 'N/A'}</span></div>
                         ${word.我的發音筆記圖檔 ? `<div class="mt-2"><strong class="font-semibold">我的筆記:</strong> <img src="${word.我的發音筆記圖檔}" class="mt-1 rounded"/></div>` : ''}
                    </div>
                `).join('');
            } else {
                wordDetailsCanvas.innerHTML = ``;
            }
        }

        function renderSpaceMenu() {
            const { activeSpace } = state;
            spaceMenu.innerHTML = DB.spaces.map(space => {
                const wordCount = DB.words.filter(w => w.情境 === space.情境名稱).length;
                return `<a href="#" class="space-menu-item flex items-center justify-between px-4 py-2 text-slate-600 rounded-md ${space.情境名稱 === activeSpace ? 'active' : ''}" data-space="${space.情境名稱}">
                    <div class="flex items-center"><i class="${space.icon || 'fa-solid fa-folder'} mr-3 text-lg w-5 text-center"></i><span>${space.情境名稱}</span></div>
                    <span class="text-xs font-semibold bg-slate-200 rounded-full px-2 py-0.5">${wordCount}</span>
                </a>`
            }).join('');
        }

        function renderWordGrid() {
            const { currentPattern, activeSpace, selectedWords } = state;
            const requiredPoSList = (currentPattern.所需詞性 || "").split(';').map(p => p.trim());
            const nextRequiredPoS = requiredPoSList[selectedWords.length] || requiredPoSList[0];

            document.getElementById('word-list-title').textContent = `${activeSpace}的相關單字 (${nextRequiredPoS})`;
            const words = DB.words.filter(w => w.詞性 === nextRequiredPoS);
            
            if (words.length > 0) {
                wordGrid.innerHTML = words.map(wordData => {
                    const isSelected = selectedWords.some(w => w.單字 === wordData.單字);
                    return `
                    <div class="word-card bg-white rounded-lg shadow-sm cursor-pointer overflow-hidden border-2 ${isSelected ? 'border-indigo-500' : 'border-slate-200'}" data-word='${JSON.stringify(wordData)}'>
                        <div class="p-3 pointer-events-none"><h4 class="font-bold text-slate-800">${wordData.單字}</h4><p class="text-sm text-slate-500">${wordData.詞性}</p></div>
                    </div>`
                }).join('');
            } else {
                 wordGrid.innerHTML = `<div class="col-span-full text-center py-12 px-4"><div class="text-5xl text-slate-400 mb-4"><i class="far fa-surprise"></i></div><h3 class="text-xl font-semibold text-slate-700">喔喔！</h3><p class="text-slate-500 mt-1">在您的單字庫中找不到詞性為「${nextRequiredPoS}」的單字。</p></div>`;
            }
        }

        function displayError(message) {
             document.getElementById('app-container').innerHTML = `<div class="p-4 text-center text-red-500">${message}</div>`;
        }
        
        function setupEventListeners() {
            spaceMenu.addEventListener('click', e => {
                e.preventDefault();
                const spaceMenuItem = e.target.closest('.space-menu-item[data-space]');
                if (spaceMenuItem) setState({ activeSpace: spaceMenuItem.dataset.space });
            });

            wordGrid.addEventListener('click', e => {
                if (state.isLoadingAi) return;
                const wordCard = e.target.closest('.word-card[data-word]');
                if (wordCard && wordCard.dataset.word) {
                    const clickedWord = JSON.parse(wordCard.dataset.word);
                    const isAlreadySelected = state.selectedWords.some(w => w.單字 === clickedWord.單字);
                    if (isAlreadySelected) {
                        setState({ selectedWords: state.selectedWords.filter(w => w.單字 !== clickedWord.單字) });
                    } else {
                        fetchAiDataForWord(clickedWord);
                    }
                }
            });
            
            controlsContainer.addEventListener('change', e => {
                if(e.target.id === 'pattern-selector') {
                    const selectedPatternName = e.target.value;
                    const newPattern = DB.patterns.find(p => p.句型名稱 === selectedPatternName);
                    if(newPattern) setState({ currentPattern: newPattern, selectedWords: [] });
                }
            });

            sentenceConstructor.addEventListener('change', e => {
                if(e.target.id === 'subject-selector') {
                    setState({ selectedSubject: e.target.value });
                }
            });
            
            sentenceConstructor.addEventListener('click', e => {
                 const wordSpan = e.target.closest('span[data-word-index]');
                 if (wordSpan) {
                    const indexToRemove = parseInt(wordSpan.dataset.wordIndex, 10);
                    const newSelectedWords = [...state.selectedWords];
                    newSelectedWords.splice(indexToRemove, 1);
                    setState({ selectedWords: newSelectedWords });
                 }
            });
            
            controlsContainer.addEventListener('click', e => {
                const categoryBtn = e.target.closest('.category-btn');
                if (categoryBtn) {
                    const category = categoryBtn.dataset.category;
                    const patternsForCategory = DB.patterns.filter(p => p.句型分類 === category);
                    if (patternsForCategory.length > 0) {
                        setState({ 
                            currentCategory: category, 
                            currentPattern: patternsForCategory[0],
                            selectedWords: [] 
                        });
                    }
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
